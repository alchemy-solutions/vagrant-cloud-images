---
- name: Build {{ distro.name }}-{{ release.version }} releases
  set_fact:
    vagrant_box: "{{ distro.name }}-{{ release.version }}"

- name: Create Vagrant Box Registry for {{ vagrant_box }}
  uri:
    url: "{{ vagrant_cloud_url }}/registry/{{ vagrant_cloud_user }}/boxes"
    method: POST
    body_format: json
    return_content: true
    headers:
      Content-Type: application/json
      Authorization: "Bearer {{ vagrant_cloud_token }}"
    body:
      name: "{{ vagrant_box }}"
      short_description: "{{ release.description }}"
  register: hcp_create_box
  failed_when: hcp_create_box.status not in [200, 409]
  changed_when: hcp_create_box.status == 200

- include_tasks: provider.yaml
  loop: "{{ release.arch }}"
  loop_control:
    loop_var: arch
